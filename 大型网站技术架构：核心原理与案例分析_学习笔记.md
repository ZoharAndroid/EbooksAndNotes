# 1 大型网站架构演化
## 1.1 大型网站软件系统的特点
* **高并发，大流量**
* **高可用：** 7x24h不间断服务。
* **海量数据**
* **用户分布广泛，网络情况复杂**
* **安全环境恶劣**
* **需求快速变更，发布频繁**
* **渐进式发展**

## 1.2 大型网站架构演化发展历程
### 1.2.1 初始阶段的网站架构
![](https://raw.githubusercontent.com/ZoharAndroid/MarkdownImages/master/%E5%88%9D%E5%A7%8B%E9%98%B6%E6%AE%B5%E7%9A%84%E7%BD%91%E7%AB%99%E6%9E%B6%E6%9E%84.png)
应用程序、数据库、文件等所有资源都在一个服务器上。操作系统为Linux，应用程序使用PHP，部署在Apache上，数据库为MySql。

### 1.2.2 应用服务器和数据服务分类
应用和数据分离之后形成三个服务器：应用服务器、文件服务器和数据库服务器。
![](https://raw.githubusercontent.com/ZoharAndroid/MarkdownImages/master/%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%92%8C%E6%95%B0%E6%8D%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%88%86%E7%A6%BB.png)
* 应用服务器：处理大量的业务逻辑，需要较好的CPU。
* 数据库服务器：快速磁盘检索和数据缓存，需要较快的的硬盘和内存。
* 文件服务器：存储用户上传文件，需要较大硬盘。
> 问题：数据库访问延时。

### 1.2.3 使用缓存改善网站性能

大部分业务访问集中在一小部分数据上，把这一小部分数据缓存在内存中，减少数据库访问压力。

缓存分两种：

1. 缓存在应用服务器上的**本地缓存**；
2. 缓存在专门的分布式缓存服务器上的**远程缓存**。

* 本地缓存：访问速度更快一些，但是受到应用服务器内存限制，缓存数据量有限，会出现和应用程序争用内存的情况
* 远程分布式缓存：使用集群的方式，部署在大内存的服务器上。
  
![](https://raw.githubusercontent.com/ZoharAndroid/MarkdownImages/master/%E7%BD%91%E7%AB%99%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98.png)
> 问题：使用缓存后，数据库访问压力可以得到缓解，但是单一应用服务器能够处理的请求连接有限，在网站访问高峰期，应用服务器成为整个网站的瓶颈。

### 1.2.4 使用应用服务器集群改善网站的并发处理能力

使用集群是网站解决高并发、海量数据问题的常用手段。当网站持续增长的业务需求，增加一台服务器分担原有的访问以及存储压力也是一种恰当的做法。
![](https://raw.githubusercontent.com/ZoharAndroid/MarkdownImages/master/%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2.png)
通过负载均衡调度服务器，将访问请求分发到应用服务器集群中的任何一台服务器中。

### 1.2.5 数据库读写分离

虽然使用缓存能够缓解部分压力，但是仍有一部分读操作（缓存不命中、缓存过期）和全部的写操作仍是需要访问数据库的。

大部分主流数据库都提供主从热备功能，通过配置两台数据库主从关系，可以将一台数据库服务器的数据更新同步到另外一台服务器上。利用这一功能，实现数据库读写分离，从而改善数据库负载压力。
![](https://raw.githubusercontent.com/ZoharAndroid/MarkdownImages/master/%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.png)
应用服务器写数据的时候，访问主数据库服务器，主数据库通过主从复制机制将数据更新同步到从数据库，这样应用服务器读取数据的时候，就可以读取从数据库服务器。应用服务器使用专门的数据访问模块，可以使数据库读写分离。

### 1.2.6 使用反向代理和CDN加速网站响应

CDN和反向代理的基本原理都是缓存。

* **CDN**部署在网络提供商的机房，使用户在请求网站服务时，可以从距离自己最近的网络提供商机房获取数据。
* **反向代理**部署在网站的中心机房，当用户请求达到中心机房后，首先访问的是反向代理服务器，如果反向代理服务器缓存着用户请求的资源，就直接返回给用户。

![](https://raw.githubusercontent.com/ZoharAndroid/MarkdownImages/master/%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%92%8CCDN%E5%8A%A0%E9%80%9F%E8%AE%BF%E9%97%AE.png)

> CDN和反向代理都是为了尽快的返回数据给用户，一方面加快用户访问速度，另一方面减轻服务器的负载压力。

### 1.2.7 使用分布式文件系统和分布式数据库系统

将数据库和文件系统拆分到多个服务器上。
![](https://raw.githubusercontent.com/ZoharAndroid/MarkdownImages/master/%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E5%92%8C%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B3%BB%E7%BB%9F.png)

> 分布式数据库是网站数据库拆分的最后手段，只有在单表数据规模非常庞大的时候才使用。不到不得已时，网站更常用的数据库拆分手段是业务分库，将不同的业务的数据库部署到不同的物理服务器上。

### 1.2.8 使用NOSQL和搜索引擎

满足数据存储和检索的需求。
![](https://raw.githubusercontent.com/ZoharAndroid/MarkdownImages/master/NoSQL%E5%92%8C%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E.png)

> NoSQL和搜索引擎对可伸缩的分布式特性具有很好的支持。
> 应用服务器通过一个统一的数据访问模块访问各种数据，减轻应用程序管理诸多数据源的麻烦。

### 1.2.9 业务拆分

* 根据产品线划分，讲一个网站拆分成许多不同的应用，每个应用独立部署维护。
* 应用之间通过一个超链接建立关系，也可以通过消息队列进行数据分发。

![](https://raw.githubusercontent.com/ZoharAndroid/MarkdownImages/master/%E5%BA%94%E7%94%A8%E6%8B%86%E5%88%86.png)

### 1.2.10 分布式服务

将相同的业务提取出来，独立部署，由可复用的业务连接数据库，来提供共用业务服务，应用系统只需要管理用户界面，通过分布式服务调用共用业务服务完成具体业务操作。
![分布式服务](https://raw.githubusercontent.com/ZoharAndroid/MarkdownImages/master/%E5%88%86%E5%B8%83%E5%BC%8F%E6%9C%8D%E5%8A%A1.png)

## 1.3 大型网站架构演化的价值观

* 大型网站架构的核心价值是**随网站所需**灵活应对。
* 驱动大型网站技术法阵的主要力量是**网站的业务发展**。

## 1.4 网站架构设计误区

* 以为追随大公司的解决方法：值得学习和借鉴，但是不能盲从。
* 为技术而技术：网站技术是为业务而存在的。
* 企图用技术解决所有问题：技术用来解决业务问题，业务问题也可以通过业务手段来解决。

# 2 大型网站架构模式

## 2.1 网站架构模式

* 问题与挑战：高并发访问、海量数据处理、高可靠运行。
* 目标：高性能、高可用、易伸缩、可扩展、安全。

## 2.1.1 分层

将系统在**横向维度**上切分成几个部分，每个部分负责相对比较单一的职责，然后通过上层对下层的依赖和调用组成一个完整的系统。

网站软件系统分为：应用层、服务层、数据层。

* 应用层：负责具体业务和视图展示，如网站首页与搜索输入和结果展示。
* 服务层：为应用层提供服务支持，如用户管理服务、购物车服务。
* 数据层：提供数据存储访问服务，如数据库、缓存、文件、搜索引擎。
> 需要严格遵守分层架构的约束，禁止跨层次调用（应用层直接调用数据层）以及逆向调用（数据层调用服务层）。

大的分层结构内部还可以继续分层：
* 应用层可以分为**视图层**和**业务逻辑层**。
* 服务层可以分为**数据接口层**和**逻辑处理层**。

在实际部署上，可以部署在同一个服务器上，也可以分别部署在不同服务器上。

### 2.1.2 分割

对软件在**纵向方面**进行切分。将不同的功能和服务分割开来，包装成高内聚低耦合的模块单元。

### 2.1.3 分布式

分割和分层的一个主要目的是为了切分后的模块便于**分布式部署**，也就是将不同的模块部署在不同的服务器上，通过远程调用协同工作。

解决高并发问题的同时也会带来的一些问题：

* 分布式服务调用必须通过网络，会造成性能影响；
* 服务器越多，宕机的可能性也就越大，也就会造成部署在该部分的应用不可访问，网站可用性降低；
* 数据在分布式环境下保持一致性也是比较困难的；
* 分布式事务难保证；
* 导致网站依赖错综复杂，开发管理维护困难。

常用的分布式方案：

* **分布式应用和服务**：分层和分割后的应用和服务模块分布式部署，不仅改善网站性能和并发性、加快开发和发布速度、减少数据库连接资源消耗，还可以让不同的应用复用共同的服务。
* **分布式静态资源**：将网站的静态资源如JS,CCS,LOGO图片等资源独立分布式部署，并采用独立的域名。静态资源分布式部署可以减轻应用服务器的负载压力；采用独立域名可以加快浏览器并发加载速度。
* **分布式数据和存储**
* **分布式计算**